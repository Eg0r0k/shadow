{"version":3,"file":"shadow.mjs","sources":["src/utils.ts","src/shadow.tsx"],"sourcesContent":["export function withType<W>(): <T>(obj: T) => T & W {\n    return obj => obj as any\n}\n","import { defineComponent, h, ref, Teleport, onBeforeMount, onMounted, computed, reactive, PropType, watch } from 'vue'\nimport type { App, VNode } from 'vue'\n\nimport { withType } from './utils'\n\nconst VIRTUAL_ROOT = document.createDocumentFragment()\n\ntype GShadowRoot = typeof global.ShadowRoot.prototype\ntype ShadowMode = 'open' | 'closed'\nexport interface ShadowOption {\n    mode?: ShadowMode\n    delegatesFocus?: boolean\n}\nexport interface ShadowRootExpose {\n    shadow_root: GShadowRoot | undefined\n}\nexport function makeShadow(el: Element, option?: ShadowOption) {\n    return makeShadowRaw(el, el.childNodes, option)\n}\n\nexport function makeShadowRaw(\n    rootEl: Element,\n    childNodes: Iterable<Node> = [],\n    { mode = 'open', delegatesFocus = false }: ShadowOption = {}\n): ShadowRoot | undefined {\n    if (rootEl.shadowRoot) {\n        console.error('[shadow] Attach shadow multiple times', rootEl, childNodes)\n        return undefined\n    }\n    if (mode !== 'open' && mode !== 'closed') {\n        console.error(`[shadow] Invalid mode: ${mode}. It should be 'open' or 'closed'.`)\n        return undefined\n    }\n    try {\n        const shadowRoot = rootEl.attachShadow({ mode, delegatesFocus })\n        putDomIntoShadow(shadowRoot, childNodes)\n        return shadowRoot\n    } catch (error) {\n        console.error('[shadow] make shadow-root failed', rootEl, childNodes, error)\n        return undefined\n    }\n}\n\nfunction putDomIntoShadow(shadowRoot: GShadowRoot, childNodes: Iterable<Node>) {\n    if (childNodes) {\n        shadowRoot.append(...Array.from(childNodes))\n    }\n}\n\nexport const ShadowStyle = defineComponent({\n    props: {\n        media: String,\n        nonce: String,\n    },\n    setup(props, { slots }) {\n        return () => h('style', { media: props.media, nonce: props.nonce }, slots.default?.())\n    },\n})\n\nexport const ShadowRoot = withType<{\n    install: typeof install\n    Style: typeof ShadowStyle\n}>()(\n    defineComponent({\n        props: {\n            mode: {\n                type: String as PropType<ShadowMode>,\n                default: 'open',\n            },\n            delegatesFocus: {\n                type: Boolean,\n                default: false,\n            },\n            abstract: {\n                type: Boolean,\n                default: false,\n            },\n            tag: {\n                type: String,\n                default: 'div',\n            },\n            adoptedStyleSheets: {\n                type: Array as PropType<CSSStyleSheet[]>,\n            },\n        },\n        emits: ['error'],\n        setup(props, { slots, expose, emit }) {\n            const abstract = ref(false)\n\n            const el = ref<HTMLElement>()\n            const teleport_el = ref<HTMLElement>()\n            const shadow_root = ref<GShadowRoot>()\n\n            const teleportTarget = computed(() => shadow_root.value ?? VIRTUAL_ROOT)\n            const ex: ShadowRootExpose = reactive({\n                shadow_root,\n            })\n            expose(ex)\n\n            onBeforeMount(() => {\n                abstract.value = props.abstract\n            })\n\n            onMounted(() => {\n                const parent = teleport_el.value?.parentElement\n\n                try {\n                    shadow_root.value = abstract.value\n                        ? parent?.shadowRoot || makeShadowRaw(parent!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                        : makeShadowRaw(el.value!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                } catch (e) {\n                    emit('error', e)\n                }\n            })\n\n            watch([shadow_root, () => props.adoptedStyleSheets], ([shadowRoot, adoptedStyleSheets]) => {\n                if (!shadowRoot || !adoptedStyleSheets) return\n                try {\n                    if ('adoptedStyleSheets' in shadowRoot) {\n                        ;(shadowRoot as any).adoptedStyleSheets = adoptedStyleSheets\n                    }\n                } catch (e) {\n                    console.error(e)\n                    emit('error', e)\n                }\n            })\n\n            return (): VNode => {\n                const childPart = (\n                    <Teleport ref={teleport_el} to={teleportTarget.value}>\n                        {slots.default?.()}\n                    </Teleport>\n                )\n\n                return props.abstract ? childPart : <props.tag ref={el}>{childPart}</props.tag>\n            }\n        },\n        install,\n        Style: ShadowStyle,\n    })\n)\n\nexport function install(app: App) {\n    app.component('shadow-root', ShadowRoot)\n\n    app.directive('shadow', {\n        beforeMount(el: HTMLElement) {\n            console.warn('[VueShadowDom] Deprecated v-shadow directive, use <shadow-root> component')\n            makeShadow(el)\n        },\n    })\n}\n\nexport { ShadowRoot as shadow_root, ShadowStyle as shadow_style }\nexport default { ShadowRoot, ShadowStyle, shadow_root: ShadowRoot, shadow_style: ShadowStyle, install }\n"],"names":[],"mappings":"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"}