{"version":3,"file":"shadow.global.prod.js","sources":["../src/shadow.tsx"],"sourcesContent":["import { defineComponent, h, ref, Teleport, onBeforeMount, onMounted, computed, reactive, PropType, watch } from 'vue'\nimport type { App, VNode } from 'vue'\n\nimport { withType } from './utils'\n\nconst VIRTUAL_ROOT = document.createDocumentFragment()\n\ntype GShadowRoot = typeof global.ShadowRoot.prototype\ntype ShadowMode = 'open' | 'closed'\nexport interface ShadowOption {\n    mode?: ShadowMode\n    delegatesFocus?: boolean\n}\nexport interface ShadowRootExpose {\n    shadow_root: GShadowRoot | undefined\n}\nexport function makeShadow(el: Element, option?: ShadowOption) {\n    return makeShadowRaw(el, el.childNodes, option)\n}\n\nexport function makeShadowRaw(\n    rootEl: Element,\n    childNodes: Iterable<Node> = [],\n    { mode = 'open', delegatesFocus = false }: ShadowOption = {}\n): ShadowRoot | undefined {\n    if (rootEl.shadowRoot) {\n        console.error('[shadow] Attach shadow multiple times', rootEl, childNodes)\n        return undefined\n    }\n    if (mode !== 'open' && mode !== 'closed') {\n        console.error(`[shadow] Invalid mode: ${mode}. It should be 'open' or 'closed'.`)\n        return undefined\n    }\n    try {\n        const shadowRoot = rootEl.attachShadow({ mode, delegatesFocus })\n        putDomIntoShadow(shadowRoot, childNodes)\n        return shadowRoot\n    } catch (error) {\n        console.error('[shadow] make shadow-root failed', rootEl, childNodes, error)\n        return undefined\n    }\n}\n\nfunction putDomIntoShadow(shadowRoot: GShadowRoot, childNodes: Iterable<Node>) {\n    if (childNodes) {\n        shadowRoot.append(...Array.from(childNodes))\n    }\n}\n\nexport const ShadowStyle = defineComponent({\n    props: {\n        media: String,\n        nonce: String,\n    },\n    setup(props, { slots }) {\n        return () => h('style', { media: props.media, nonce: props.nonce }, slots.default?.())\n    },\n})\n\nexport const ShadowRoot = withType<{\n    install: typeof install\n    Style: typeof ShadowStyle\n}>()(\n    defineComponent({\n        props: {\n            mode: {\n                type: String as PropType<ShadowMode>,\n                default: 'open',\n            },\n            delegatesFocus: {\n                type: Boolean,\n                default: false,\n            },\n            abstract: {\n                type: Boolean,\n                default: false,\n            },\n            tag: {\n                type: String,\n                default: 'div',\n            },\n            adoptedStyleSheets: {\n                type: Array as PropType<CSSStyleSheet[]>,\n            },\n        },\n        emits: ['error'],\n        setup(props, { slots, expose, emit }) {\n            const abstract = ref(false)\n\n            const el = ref<HTMLElement>()\n            const teleport_el = ref<HTMLElement>()\n            const shadow_root = ref<GShadowRoot>()\n\n            const teleportTarget = computed(() => shadow_root.value ?? VIRTUAL_ROOT)\n            const ex: ShadowRootExpose = reactive({\n                shadow_root,\n            })\n            expose(ex)\n\n            onBeforeMount(() => {\n                abstract.value = props.abstract\n            })\n\n            onMounted(() => {\n                const parent = teleport_el.value?.parentElement\n\n                try {\n                    shadow_root.value = abstract.value\n                        ? parent?.shadowRoot || makeShadowRaw(parent!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                        : makeShadowRaw(el.value!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                } catch (e) {\n                    emit('error', e)\n                }\n            })\n\n            watch([shadow_root, () => props.adoptedStyleSheets], ([shadowRoot, adoptedStyleSheets]) => {\n                if (!shadowRoot || !adoptedStyleSheets) return\n                try {\n                    if ('adoptedStyleSheets' in shadowRoot) {\n                        ;(shadowRoot as any).adoptedStyleSheets = adoptedStyleSheets\n                    }\n                } catch (e) {\n                    console.error(e)\n                    emit('error', e)\n                }\n            })\n\n            return (): VNode => {\n                const childPart = (\n                    <Teleport ref={teleport_el} to={teleportTarget.value}>\n                        {slots.default?.()}\n                    </Teleport>\n                )\n\n                return props.abstract ? childPart : <props.tag ref={el}>{childPart}</props.tag>\n            }\n        },\n        install,\n        Style: ShadowStyle,\n    })\n)\n\nexport function install(app: App) {\n    app.component('shadow-root', ShadowRoot)\n\n    app.directive('shadow', {\n        beforeMount(el: HTMLElement) {\n            console.warn('[VueShadowDom] Deprecated v-shadow directive, use <shadow-root> component')\n            makeShadow(el)\n        },\n    })\n}\n\nexport { ShadowRoot as shadow_root, ShadowStyle as shadow_style }\nexport default { ShadowRoot, ShadowStyle, shadow_root: ShadowRoot, shadow_style: ShadowStyle, install }\n"],"names":["VIRTUAL_ROOT","document","createDocumentFragment","makeShadow","el","option","makeShadowRaw","childNodes","rootEl","mode","delegatesFocus","shadowRoot","console","error","attachShadow","append","Array","from","putDomIntoShadow","ShadowStyle","defineComponent","props","media","String","nonce","setup","slots","h","default","ShadowRoot","type","Boolean","abstract","tag","adoptedStyleSheets","emits","expose","emit","ref","teleport_el","shadow_root","teleportTarget","computed","value","reactive","onBeforeMount","onMounted","parent","parentElement","undefined","e","watch","childPart","Teleport","to","install","Style","app","component","directive","beforeMount","warn","shadow","shadow_style"],"mappings":"2QAKA,MAAMA,EAAeC,SAASC,yBAWd,SAAAC,EAAWC,EAAaC,GACpC,OAAOC,EAAcF,EAAIA,EAAGG,WAAYF,EAC5C,UAEgBC,EACZE,EACAD,EAA6B,IAC7BE,KAAEA,EAAO,OAAMC,eAAEA,GAAiB,GAAwB,IAE1D,GAAIF,EAAOG,WACPC,QAAQC,MAAM,wCAAyCL,EAAQD,QAGnE,GAAa,SAATE,GAA4B,WAATA,EAIvB,IACI,MAAME,EAAaH,EAAOM,aAAa,CAAEL,OAAMC,mBAE/C,OAOR,SAA0BC,EAAyBJ,GAC3CA,GACAI,EAAWI,UAAUC,MAAMC,KAAKV,GAExC,CAZQW,CAAiBP,EAAYJ,GACtBI,CACV,CAAC,MAAOE,GAEL,YADAD,QAAQC,MAAM,mCAAoCL,EAAQD,EAAYM,EAEzE,MAVGD,QAAQC,MAAM,0BAA0BJ,sCAWhD,CAQa,MAAAU,EAAcC,EAAAA,gBAAgB,CACvCC,MAAO,CACHC,MAAOC,OACPC,MAAOD,QAEXE,MAAK,CAACJ,GAAOK,MAAEA,KACJ,IAAMC,EAAAA,EAAE,QAAS,CAAEL,MAAOD,EAAMC,MAAOE,MAAOH,EAAMG,OAASE,EAAME,eAIrEC,EAITT,kBAAgB,CACZC,MAAO,CACHZ,KAAM,CACFqB,KAAMP,OACNK,QAAS,QAEblB,eAAgB,CACZoB,KAAMC,QACNH,SAAS,GAEbI,SAAU,CACNF,KAAMC,QACNH,SAAS,GAEbK,IAAK,CACDH,KAAMP,OACNK,QAAS,OAEbM,mBAAoB,CAChBJ,KAAMd,QAGdmB,MAAO,CAAC,SACR,KAAAV,CAAMJ,GAAOK,MAAEA,EAAKU,OAAEA,EAAMC,KAAEA,IAC1B,MAAML,EAAWM,OAAI,GAEflC,EAAKkC,EAAAA,MACLC,EAAcD,EAAAA,MACdE,EAAcF,EAAAA,MAEdG,EAAiBC,EAAAA,UAAS,IAAMF,EAAYG,OAAS3C,IAkC3D,OA9BAoC,EAH6BQ,EAAAA,SAAS,CAClCJ,iBAIJK,EAAAA,eAAc,KACVb,EAASW,MAAQtB,EAAMW,QAAQ,IAGnCc,EAAAA,WAAU,KACN,MAAMC,EAASR,EAAYI,OAAOK,cAElC,IACIR,EAAYG,MAAQX,EAASW,MACvBI,GAAQpC,YAAcL,EAAcyC,OAASE,EAAW,CAAExC,KAAMY,EAAMZ,KAAMC,eAAgBW,EAAMX,iBAClGJ,EAAcF,EAAGuC,WAAQM,EAAW,CAAExC,KAAMY,EAAMZ,KAAMC,eAAgBW,EAAMX,gBACvF,CAAC,MAAOwC,GACLb,EAAK,QAASa,EACjB,KAGLC,QAAM,CAACX,EAAa,IAAMnB,EAAMa,qBAAqB,EAAEvB,EAAYuB,MAC/D,GAAKvB,GAAeuB,EACpB,IACQ,uBAAwBvB,IACtBA,EAAmBuB,mBAAqBA,EAEjD,CAAC,MAAOgB,GACLtC,QAAQC,MAAMqC,GACdb,EAAK,QAASa,EACjB,KAGE,KACH,MAAME,EACFzB,EAAAA,EAAC0B,WAAS,CAAAf,IAAKC,EAAae,GAAIb,EAAeE,OAC1CjB,EAAME,aAIf,OAAOP,EAAMW,SAAWoB,EAAYzB,IAACN,EAAMY,IAAI,CAAAK,IAAKlC,GAAKgD,EAAsB,CAEtF,EACDG,UACAC,MAAOrC,IAIT,SAAUoC,EAAQE,GACpBA,EAAIC,UAAU,cAAe7B,GAE7B4B,EAAIE,UAAU,SAAU,CACpB,WAAAC,CAAYxD,GACRQ,QAAQiD,KAAK,6EACb1D,EAAWC,EACd,GAET,CAGA,IAAA0D,EAAe,CAAEjC,aAAYV,cAAaqB,YAAaX,EAAYkC,aAAc5C,EAAaoC"}