{"version":3,"file":"shadow.cdn-jsdelivr.mjs","sources":["../src/utils.ts","../src/shadow.tsx"],"sourcesContent":["export function withType<W>() {\n    return function <T>(obj: T): T & W {\n        return obj as T & W\n    }\n}\n","import { defineComponent, h, ref, Teleport, onBeforeMount, onMounted, computed, reactive, PropType, watch } from 'vue'\nimport type { App, Directive, VNode } from 'vue'\n\nimport { withType } from './utils'\n\nconst VIRTUAL_ROOT = document.createDocumentFragment()\ninterface AdoptableShadowRoot extends ShadowRoot {\n    adoptedStyleSheets: CSSStyleSheet[]\n}\ntype ShadowRootComponent = {\n    install: typeof install\n    Style: typeof ShadowStyle\n}\n\ntype GShadowRoot = typeof global.ShadowRoot.prototype\ntype ShadowMode = 'open' | 'closed'\nexport interface ShadowOption {\n    mode?: ShadowMode\n    delegatesFocus?: boolean\n}\nexport interface ShadowRootExpose {\n    shadow_root: GShadowRoot | undefined\n}\nexport function makeShadow(el: Element, option?: ShadowOption): ShadowRoot | undefined {\n    return makeShadowRaw(el, el.childNodes, option);\n}\n\n\nexport function makeShadowRaw(rootEl: Element, childNodes: Iterable<Node> = [], { mode = 'open', delegatesFocus = false }: ShadowOption = {}): ShadowRoot | undefined{\n    if (rootEl.shadowRoot) {\n        console.error('[shadow] Attach shadow multiple times', rootEl, childNodes)\n        return undefined\n    }\n    if (mode !== 'open' && mode !== 'closed') {\n        console.error(`[shadow] Invalid mode: ${mode}. It should be 'open' or 'closed'.`)\n        return undefined\n    }\n    try {\n        const shadowRoot = rootEl.attachShadow({ mode, delegatesFocus })\n        putDomIntoShadow(shadowRoot, childNodes)\n        return shadowRoot\n    } catch (error) {\n        console.error('[shadow] make shadow-root failed', rootEl, childNodes, error)\n        return undefined\n    }\n}\n\nfunction putDomIntoShadow(shadowRoot: GShadowRoot, childNodes: Iterable<Node>) {\n    if (childNodes) {\n        shadowRoot.append(...Array.from(childNodes))\n    }\n}\n\nexport const ShadowStyle = defineComponent({\n    props: {\n        media: String,\n        nonce: String,\n    },\n    setup(props, { slots }) {\n        return () => h('style', { media: props.media, nonce: props.nonce }, slots.default?.())\n    },\n})\n\nexport const ShadowRoot = withType<ShadowRootComponent>()(\n    defineComponent({\n        props: {\n            mode: {\n                type: String as PropType<ShadowMode>,\n                default: 'open',\n            },\n            delegatesFocus: {\n                type: Boolean,\n                default: false,\n            },\n            abstract: {\n                type: Boolean,\n                default: false,\n            },\n            tag: {\n                type: String,\n                default: 'div',\n            },\n            adoptedStyleSheets: {\n                type: Array as PropType<CSSStyleSheet[]>,\n            },\n        },\n        emits: ['error'],\n        setup(props, { slots, expose, emit }) {\n            const abstract = ref(false)\n\n            const el = ref<HTMLElement>()\n            const teleport_el = ref<HTMLElement>()\n            const shadow_root = ref<GShadowRoot>()\n\n            const teleport_target = computed(() => shadow_root.value ?? VIRTUAL_ROOT)\n\n            const expose_data: ShadowRootExpose = reactive({\n                shadow_root,\n            });\n            expose(expose_data)\n\n            onBeforeMount(() => {\n                abstract.value = props.abstract\n            })\n\n            onMounted(() => {\n                const parent = teleport_el.value?.parentElement;\n\n                try {\n                    shadow_root.value = abstract.value\n                        ? parent?.shadowRoot || makeShadowRaw(parent!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                        : makeShadowRaw(el.value!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus });\n                } catch (e) {\n                    emit('error', e);\n                }\n            })\n\n            watch([shadow_root, () => props.adoptedStyleSheets], ([shadowRoot, adoptedStyleSheets]) => {\n                if (!shadowRoot || !adoptedStyleSheets) return\n                try {\n                    if ('adoptedStyleSheets' in shadowRoot) {\n                        (shadowRoot as AdoptableShadowRoot).adoptedStyleSheets = adoptedStyleSheets;                     }\n                } catch (e) {\n                    console.error(e)\n                    emit('error', e)\n                }\n            })\n\n          \n            return (): VNode => {\n                const child_part = (\n                    <Teleport ref={teleport_el} to={teleport_target.value}>\n                        {[slots.default?.()]}\n                    </Teleport>\n                )\n                if (abstract.value) return child_part\n                return <props.tag ref={el}>{child_part}</props.tag>\n            }\n        },\n        install,\n        Style: ShadowStyle,\n    })\n)\nconst shadowDirective: Directive<HTMLElement> = {\n    beforeMount(el: HTMLElement) { \n        console.warn('[VueShadowDom] Deprecated v-shadow directive, use <shadow-root> component');\n        makeShadow(el, { mode: 'closed', delegatesFocus: true });\n    },\n};\nexport function install(app: App) {\n    app.component('shadow-root', ShadowRoot)\n\n    app.directive('shadow', shadowDirective)\n}\nexport { ShadowRoot as shadow_root, ShadowStyle as shadow_style }\nexport default { ShadowRoot, ShadowStyle, shadow_root: ShadowRoot, shadow_style: ShadowStyle, install }\n"],"names":[],"mappings":"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"}