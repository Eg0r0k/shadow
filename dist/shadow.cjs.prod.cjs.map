{"version":3,"file":"shadow.cjs.prod.cjs","sources":["../src/shadow.tsx"],"sourcesContent":["import { defineComponent, h, ref, Teleport, onBeforeMount, onMounted, computed, reactive, PropType, watch } from 'vue'\nimport type { App, Directive, VNode } from 'vue'\n\nimport { withType } from './utils'\n\nconst VIRTUAL_ROOT = document.createDocumentFragment()\ninterface AdoptableShadowRoot extends ShadowRoot {\n    adoptedStyleSheets: CSSStyleSheet[]\n}\ntype ShadowRootComponent = {\n    install: typeof install\n    Style: typeof ShadowStyle\n}\n\ntype GShadowRoot = typeof global.ShadowRoot.prototype\ntype ShadowMode = 'open' | 'closed'\nexport interface ShadowOption {\n    mode?: ShadowMode\n    delegatesFocus?: boolean\n}\nexport interface ShadowRootExpose {\n    shadow_root: GShadowRoot | undefined\n}\nexport function makeShadow(el: Element, option?: ShadowOption): ShadowRoot | undefined {\n    return makeShadowRaw(el, el.childNodes, option);\n}\n\n\nexport function makeShadowRaw(rootEl: Element, childNodes: Iterable<Node> = [], { mode = 'open', delegatesFocus = false }: ShadowOption = {}): ShadowRoot | undefined{\n    if (rootEl.shadowRoot) {\n        console.error('[shadow] Attach shadow multiple times', rootEl, childNodes)\n        return undefined\n    }\n    if (mode !== 'open' && mode !== 'closed') {\n        console.error(`[shadow] Invalid mode: ${mode}. It should be 'open' or 'closed'.`)\n        return undefined\n    }\n    try {\n        const shadowRoot = rootEl.attachShadow({ mode, delegatesFocus })\n        putDomIntoShadow(shadowRoot, childNodes)\n        return shadowRoot\n    } catch (error) {\n        console.error('[shadow] make shadow-root failed', rootEl, childNodes, error)\n        return undefined\n    }\n}\n\nfunction putDomIntoShadow(shadowRoot: GShadowRoot, childNodes: Iterable<Node>) {\n    if (childNodes) {\n        shadowRoot.append(...Array.from(childNodes))\n    }\n}\n\nexport const ShadowStyle = defineComponent({\n    props: {\n        media: String,\n        nonce: String,\n    },\n    setup(props, { slots }) {\n        return () => h('style', { media: props.media, nonce: props.nonce }, slots.default?.())\n    },\n})\n\nexport const ShadowRoot = withType<ShadowRootComponent>()(\n    defineComponent({\n        props: {\n            mode: {\n                type: String as PropType<ShadowMode>,\n                default: 'open',\n            },\n            delegatesFocus: {\n                type: Boolean,\n                default: false,\n            },\n            abstract: {\n                type: Boolean,\n                default: false,\n            },\n            tag: {\n                type: String,\n                default: 'div',\n            },\n            adoptedStyleSheets: {\n                type: Array as PropType<CSSStyleSheet[]>,\n            },\n        },\n        emits: ['error'],\n        setup(props, { slots, expose, emit }) {\n            const abstract = ref(false)\n\n            const el = ref<HTMLElement>()\n            const teleport_el = ref<HTMLElement>()\n            const shadow_root = ref<GShadowRoot>()\n\n            const teleport_target = computed(() => shadow_root.value ?? VIRTUAL_ROOT)\n\n            const expose_data: ShadowRootExpose = reactive({\n                shadow_root,\n            });\n            expose(expose_data)\n\n            onBeforeMount(() => {\n                abstract.value = props.abstract\n            })\n\n            onMounted(() => {\n                const parent = teleport_el.value?.parentElement;\n\n                try {\n                    shadow_root.value = abstract.value\n                        ? parent?.shadowRoot || makeShadowRaw(parent!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                        : makeShadowRaw(el.value!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus });\n                } catch (e) {\n                    emit('error', e);\n                }\n            })\n\n            watch([shadow_root, () => props.adoptedStyleSheets], ([shadowRoot, adoptedStyleSheets]) => {\n                if (!shadowRoot || !adoptedStyleSheets) return\n                try {\n                    if ('adoptedStyleSheets' in shadowRoot) {\n                        (shadowRoot as AdoptableShadowRoot).adoptedStyleSheets = adoptedStyleSheets;                     }\n                } catch (e) {\n                    console.error(e)\n                    emit('error', e)\n                }\n            })\n\n          \n            return (): VNode => {\n                const child_part = (\n                    <Teleport ref={teleport_el} to={teleport_target.value}>\n                        {[slots.default?.()]}\n                    </Teleport>\n                )\n                if (abstract.value) return child_part\n                return <props.tag ref={el}>{child_part}</props.tag>\n            }\n        },\n        install,\n        Style: ShadowStyle,\n    })\n)\nconst shadowDirective: Directive<HTMLElement> = {\n    beforeMount(el: HTMLElement) { \n        console.warn('[VueShadowDom] Deprecated v-shadow directive, use <shadow-root> component');\n        makeShadow(el, { mode: 'closed', delegatesFocus: true });\n    },\n};\nexport function install(app: App) {\n    app.component('shadow-root', ShadowRoot)\n\n    app.directive('shadow', shadowDirective)\n}\nexport { ShadowRoot as shadow_root, ShadowStyle as shadow_style }\nexport default { ShadowRoot, ShadowStyle, shadow_root: ShadowRoot, shadow_style: ShadowStyle, install }\n"],"names":["VIRTUAL_ROOT","document","createDocumentFragment","makeShadow","el","option","makeShadowRaw","childNodes","rootEl","mode","delegatesFocus","shadowRoot","console","error","attachShadow","append","Array","from","putDomIntoShadow","ShadowStyle","defineComponent","props","media","String","nonce","setup","slots","h","default","ShadowRoot","type","Boolean","abstract","tag","adoptedStyleSheets","emits","expose","emit","ref","teleport_el","shadow_root","teleport_target","computed","value","reactive","onBeforeMount","onMounted","parent","parentElement","undefined","e","watch","child_part","Teleport","to","install","Style","shadowDirective","beforeMount","warn","app","component","directive","shadow","shadow_style"],"mappings":"yFAKA,MAAMA,EAAeC,SAASC,yBAkBd,SAAAC,EAAWC,EAAaC,GACpC,OAAOC,EAAcF,EAAIA,EAAGG,WAAYF,EAC5C,UAGgBC,EAAcE,EAAiBD,EAA6B,IAAIE,KAAEA,EAAO,OAAMC,eAAEA,GAAiB,GAAwB,IACtI,GAAIF,EAAOG,WACPC,QAAQC,MAAM,wCAAyCL,EAAQD,QAGnE,GAAa,SAATE,GAA4B,WAATA,EAIvB,IACI,MAAME,EAAaH,EAAOM,aAAa,CAAEL,OAAMC,mBAE/C,OAOR,SAA0BC,EAAyBJ,GAC3CA,GACAI,EAAWI,UAAUC,MAAMC,KAAKV,GAExC,CAZQW,CAAiBP,EAAYJ,GACtBI,CACV,CAAC,MAAOE,GAEL,YADAD,QAAQC,MAAM,mCAAoCL,EAAQD,EAAYM,EAEzE,MAVGD,QAAQC,MAAM,0BAA0BJ,sCAWhD,CAQO,MAAMU,EAAcC,EAAAA,gBAAgB,CACvCC,MAAO,CACHC,MAAOC,OACPC,MAAOD,QAEXE,MAAK,CAACJ,GAAOK,MAAEA,KACJ,IAAMC,EAAAA,EAAE,QAAS,CAAEL,MAAOD,EAAMC,MAAOE,MAAOH,EAAMG,OAASE,EAAME,eAIrEC,EACTT,kBAAgB,CACZC,MAAO,CACHZ,KAAM,CACFqB,KAAMP,OACNK,QAAS,QAEblB,eAAgB,CACZoB,KAAMC,QACNH,SAAS,GAEbI,SAAU,CACNF,KAAMC,QACNH,SAAS,GAEbK,IAAK,CACDH,KAAMP,OACNK,QAAS,OAEbM,mBAAoB,CAChBJ,KAAMd,QAGdmB,MAAO,CAAC,SACR,KAAAV,CAAMJ,GAAOK,MAAEA,EAAKU,OAAEA,EAAMC,KAAEA,IAC1B,MAAML,EAAWM,OAAI,GAEflC,EAAKkC,EAAAA,MACLC,EAAcD,EAAAA,MACdE,EAAcF,EAAAA,MAEdG,EAAkBC,EAAAA,UAAS,IAAMF,EAAYG,OAAS3C,IAmC5D,OA9BAoC,EAHsCQ,EAAAA,SAAS,CAC3CJ,iBAIJK,EAAAA,eAAc,KACVb,EAASW,MAAQtB,EAAMW,QAAQ,IAGnCc,EAAAA,WAAU,KACN,MAAMC,EAASR,EAAYI,OAAOK,cAElC,IACIR,EAAYG,MAAQX,EAASW,MACvBI,GAAQpC,YAAcL,EAAcyC,OAASE,EAAW,CAAExC,KAAMY,EAAMZ,KAAMC,eAAgBW,EAAMX,iBAClGJ,EAAcF,EAAGuC,WAAQM,EAAW,CAAExC,KAAMY,EAAMZ,KAAMC,eAAgBW,EAAMX,gBACvF,CAAC,MAAOwC,GACLb,EAAK,QAASa,EACjB,KAGLC,QAAM,CAACX,EAAa,IAAMnB,EAAMa,qBAAqB,EAAEvB,EAAYuB,MAC/D,GAAKvB,GAAeuB,EACpB,IACQ,uBAAwBvB,IACvBA,EAAmCuB,mBAAqBA,EAChE,CAAC,MAAOgB,GACLtC,QAAQC,MAAMqC,GACdb,EAAK,QAASa,EACjB,KAIE,KACH,MAAME,EACFzB,EAACA,EAAA0B,EAAQA,UAACf,IAAKC,EAAae,GAAIb,EAAgBE,OAC3C,CAACjB,EAAME,cAGhB,OAAII,EAASW,MAAcS,EACpBzB,EAAAA,EAACN,EAAMY,IAAG,CAACK,IAAKlC,GAAKgD,EAAuB,CAE1D,EACDG,UACAC,MAAOrC,IAGTsC,EAA0C,CAC5C,WAAAC,CAAYtD,GACRQ,QAAQ+C,KAAK,6EACbxD,EAAWC,EAAI,CAAEK,KAAM,SAAUC,gBAAgB,GACpD,GAEC,SAAU6C,EAAQK,GACpBA,EAAIC,UAAU,cAAehC,GAE7B+B,EAAIE,UAAU,SAAUL,EAC5B,CAEA,IAAAM,EAAe,CAAElC,aAAYV,cAAaqB,YAAaX,EAAYmC,aAAc7C,EAAaoC"}