{"version":3,"file":"shadow.global.js","sources":["../src/utils.ts","../src/shadow.tsx"],"sourcesContent":["export function withType<W>() {\n    return function <T>(obj: T): T & W {\n        return obj as T & W\n    }\n}\n","import { defineComponent, h, ref, Teleport, onBeforeMount, onMounted, computed, reactive, PropType, watch } from 'vue'\nimport type { App, Directive, VNode } from 'vue'\n\nimport { withType } from './utils'\n\nconst VIRTUAL_ROOT = document.createDocumentFragment()\ninterface AdoptableShadowRoot extends ShadowRoot {\n    adoptedStyleSheets: CSSStyleSheet[]\n}\ntype ShadowRootComponent = {\n    install: typeof install\n    Style: typeof ShadowStyle\n}\n\ntype GShadowRoot = typeof global.ShadowRoot.prototype\ntype ShadowMode = 'open' | 'closed'\nexport interface ShadowOption {\n    mode?: ShadowMode\n    delegatesFocus?: boolean\n}\nexport interface ShadowRootExpose {\n    shadow_root: GShadowRoot | undefined\n}\nexport function makeShadow(el: Element, option?: ShadowOption): ShadowRoot | undefined {\n    return makeShadowRaw(el, el.childNodes, option);\n}\n\n\nexport function makeShadowRaw(rootEl: Element, childNodes: Iterable<Node> = [], { mode = 'open', delegatesFocus = false }: ShadowOption = {}): ShadowRoot | undefined{\n    if (rootEl.shadowRoot) {\n        console.error('[shadow] Attach shadow multiple times', rootEl, childNodes)\n        return undefined\n    }\n    if (mode !== 'open' && mode !== 'closed') {\n        console.error(`[shadow] Invalid mode: ${mode}. It should be 'open' or 'closed'.`)\n        return undefined\n    }\n    try {\n        const shadowRoot = rootEl.attachShadow({ mode, delegatesFocus })\n        putDomIntoShadow(shadowRoot, childNodes)\n        return shadowRoot\n    } catch (error) {\n        console.error('[shadow] make shadow-root failed', rootEl, childNodes, error)\n        return undefined\n    }\n}\n\nfunction putDomIntoShadow(shadowRoot: GShadowRoot, childNodes: Iterable<Node>) {\n    if (childNodes) {\n        shadowRoot.append(...Array.from(childNodes))\n    }\n}\n\nexport const ShadowStyle = defineComponent({\n    props: {\n        media: String,\n        nonce: String,\n    },\n    setup(props, { slots }) {\n        return () => h('style', { media: props.media, nonce: props.nonce }, slots.default?.())\n    },\n})\n\nexport const ShadowRoot = withType<ShadowRootComponent>()(\n    defineComponent({\n        props: {\n            mode: {\n                type: String as PropType<ShadowMode>,\n                default: 'open',\n            },\n            delegatesFocus: {\n                type: Boolean,\n                default: false,\n            },\n            abstract: {\n                type: Boolean,\n                default: false,\n            },\n            tag: {\n                type: String,\n                default: 'div',\n            },\n            adoptedStyleSheets: {\n                type: Array as PropType<CSSStyleSheet[]>,\n            },\n        },\n        emits: ['error'],\n        setup(props, { slots, expose, emit }) {\n            const abstract = ref(false)\n\n            const el = ref<HTMLElement>()\n            const teleport_el = ref<HTMLElement>()\n            const shadow_root = ref<GShadowRoot>()\n\n            const teleport_target = computed(() => shadow_root.value ?? VIRTUAL_ROOT)\n\n            const expose_data: ShadowRootExpose = reactive({\n                shadow_root,\n            });\n            expose(expose_data)\n\n            onBeforeMount(() => {\n                abstract.value = props.abstract\n            })\n\n            onMounted(() => {\n                const parent = teleport_el.value?.parentElement;\n\n                try {\n                    shadow_root.value = abstract.value\n                        ? parent?.shadowRoot || makeShadowRaw(parent!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                        : makeShadowRaw(el.value!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus });\n                } catch (e) {\n                    emit('error', e);\n                }\n            })\n\n            watch([shadow_root, () => props.adoptedStyleSheets], ([shadowRoot, adoptedStyleSheets]) => {\n                if (!shadowRoot || !adoptedStyleSheets) return\n                try {\n                    if ('adoptedStyleSheets' in shadowRoot) {\n                        (shadowRoot as AdoptableShadowRoot).adoptedStyleSheets = adoptedStyleSheets;                     }\n                } catch (e) {\n                    console.error(e)\n                    emit('error', e)\n                }\n            })\n\n          \n            return (): VNode => {\n                const child_part = (\n                    <Teleport ref={teleport_el} to={teleport_target.value}>\n                        {[slots.default?.()]}\n                    </Teleport>\n                )\n                if (abstract.value) return child_part\n                return <props.tag ref={el}>{child_part}</props.tag>\n            }\n        },\n        install,\n        Style: ShadowStyle,\n    })\n)\nconst shadowDirective: Directive<HTMLElement> = {\n    beforeMount(el: HTMLElement) { \n        console.warn('[VueShadowDom] Deprecated v-shadow directive, use <shadow-root> component');\n        makeShadow(el, { mode: 'closed', delegatesFocus: true });\n    },\n};\nexport function install(app: App) {\n    app.component('shadow-root', ShadowRoot)\n\n    app.directive('shadow', shadowDirective)\n}\nexport { ShadowRoot as shadow_root, ShadowStyle as shadow_style }\nexport default { ShadowRoot, ShadowStyle, shadow_root: ShadowRoot, shadow_style: ShadowStyle, install }\n"],"names":["defineComponent","h","ref","computed","reactive","onBeforeMount","onMounted","watch","Teleport"],"mappings":"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"}