{"version":3,"file":"shadow.global.js","sources":["../src/utils.ts","../src/shadow.tsx"],"sourcesContent":["export function withType<W>(): <T>(obj: T) => T & W {\n    return obj => obj as any\n}\n","import { defineComponent, h, ref, Teleport, onBeforeMount, onMounted, computed, reactive, PropType, watch } from 'vue'\nimport type { App, VNode } from 'vue'\n\nimport { withType } from './utils'\n\nconst VIRTUAL_ROOT = document.createDocumentFragment()\n\ntype GShadowRoot = typeof global.ShadowRoot.prototype\ntype ShadowMode = 'open' | 'closed'\nexport interface ShadowOption {\n    mode?: ShadowMode\n    delegatesFocus?: boolean\n}\nexport interface ShadowRootExpose {\n    shadow_root: GShadowRoot | undefined\n}\nexport function makeShadow(el: Element, option?: ShadowOption) {\n    return makeShadowRaw(el, el.childNodes, option)\n}\n\nexport function makeShadowRaw(\n    rootEl: Element,\n    childNodes: Iterable<Node> = [],\n    { mode = 'open', delegatesFocus = false }: ShadowOption = {}\n): ShadowRoot | undefined {\n    if (rootEl.shadowRoot) {\n        console.error('[shadow] Attach shadow multiple times', rootEl, childNodes)\n        return undefined\n    }\n    if (mode !== 'open' && mode !== 'closed') {\n        console.error(`[shadow] Invalid mode: ${mode}. It should be 'open' or 'closed'.`)\n        return undefined\n    }\n    try {\n        const shadowRoot = rootEl.attachShadow({ mode, delegatesFocus })\n        putDomIntoShadow(shadowRoot, childNodes)\n        return shadowRoot\n    } catch (error) {\n        console.error('[shadow] make shadow-root failed', rootEl, childNodes, error)\n        return undefined\n    }\n}\n\nfunction putDomIntoShadow(shadowRoot: GShadowRoot, childNodes: Iterable<Node>) {\n    if (childNodes) {\n        shadowRoot.append(...Array.from(childNodes))\n    }\n}\n\nexport const ShadowStyle = defineComponent({\n    props: {\n        media: String,\n        nonce: String,\n    },\n    setup(props, { slots }) {\n        return () => h('style', { media: props.media, nonce: props.nonce }, slots.default?.())\n    },\n})\n\nexport const ShadowRoot = withType<{\n    install: typeof install\n    Style: typeof ShadowStyle\n}>()(\n    defineComponent({\n        props: {\n            mode: {\n                type: String as PropType<ShadowMode>,\n                default: 'open',\n            },\n            delegatesFocus: {\n                type: Boolean,\n                default: false,\n            },\n            abstract: {\n                type: Boolean,\n                default: false,\n            },\n            tag: {\n                type: String,\n                default: 'div',\n            },\n            adoptedStyleSheets: {\n                type: Array as PropType<CSSStyleSheet[]>,\n            },\n        },\n        emits: ['error'],\n        setup(props, { slots, expose, emit }) {\n            const abstract = ref(false)\n\n            const el = ref<HTMLElement>()\n            const teleport_el = ref<HTMLElement>()\n            const shadow_root = ref<GShadowRoot>()\n\n            const teleportTarget = computed(() => shadow_root.value ?? VIRTUAL_ROOT)\n            const ex: ShadowRootExpose = reactive({\n                shadow_root,\n            })\n            expose(ex)\n\n            onBeforeMount(() => {\n                abstract.value = props.abstract\n            })\n\n            onMounted(() => {\n                const parent = teleport_el.value?.parentElement\n\n                try {\n                    shadow_root.value = abstract.value\n                        ? parent?.shadowRoot || makeShadowRaw(parent!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                        : makeShadowRaw(el.value!, undefined, { mode: props.mode, delegatesFocus: props.delegatesFocus })\n                } catch (e) {\n                    emit('error', e)\n                }\n            })\n\n            watch([shadow_root, () => props.adoptedStyleSheets], ([shadowRoot, adoptedStyleSheets]) => {\n                if (!shadowRoot || !adoptedStyleSheets) return\n                try {\n                    if ('adoptedStyleSheets' in shadowRoot) {\n                        ;(shadowRoot as any).adoptedStyleSheets = adoptedStyleSheets\n                    }\n                } catch (e) {\n                    console.error(e)\n                    emit('error', e)\n                }\n            })\n\n            return (): VNode => {\n                const childPart = (\n                    <Teleport ref={teleport_el} to={teleportTarget.value}>\n                        {slots.default?.()}\n                    </Teleport>\n                )\n\n                return props.abstract ? childPart : <props.tag ref={el}>{childPart}</props.tag>\n            }\n        },\n        install,\n        Style: ShadowStyle,\n    })\n)\n\nexport function install(app: App) {\n    app.component('shadow-root', ShadowRoot)\n\n    app.directive('shadow', {\n        beforeMount(el: HTMLElement) {\n            console.warn('[VueShadowDom] Deprecated v-shadow directive, use <shadow-root> component')\n            makeShadow(el)\n        },\n    })\n}\n\nexport { ShadowRoot as shadow_root, ShadowStyle as shadow_style }\nexport default { ShadowRoot, ShadowStyle, shadow_root: ShadowRoot, shadow_style: ShadowStyle, install }\n"],"names":["defineComponent","h","ref","computed","reactive","onBeforeMount","onMounted","watch","Teleport"],"mappings":"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"}